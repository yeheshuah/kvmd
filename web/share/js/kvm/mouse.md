# PiKVM Mouse Module - Функциональность и архитектура

## Основные режимы работы

### 1. Абсолютный режим (Absolute Mode)
- Мышь работает как графический планшет
- Позиция курсора соответствует позиции касания/клика на экране

### 2. Относительный режим (Relative Mode)
- Мышь работает как обычная компьютерная мышь
- Движения относительные (дельта от предыдущей позиции)

## Текущая функциональность

### Обработка событий мыши
- Клик левой/правой/средней кнопкой - эмуляция нажатий мыши
- Движение мыши - абсолютное или относительное позиционирование
- Прокрутка колеса - вертикальная и горизонтальная прокрутка
- Дополнительные кнопки - боковые кнопки мыши (up/down)

### Обработка сенсорных событий
- Одно касание - движение мыши или клик
- Два касания - прокрутка (жест скролла)
- Множественные касания - игнорируются для предотвращения конфликтов

### Настройки и конфигурация
- Чувствительность - настройка скорости относительного движения
- Скорость прокрутки - настройка шага прокрутки
- Кумулятивная прокрутка - накопление мелких движений прокрутки
- Обратная прокрутка - инверсия направления прокрутки
- Сжатие событий - группировка множественных относительных движений

## Детальное описание функций

### Инициализация и настройка

#### `__init__()`
- Инициализация всех обработчиков событий
- Настройка WebSocket соединения
- Установка начальных параметров

#### `__updateOnlineLeds()`
- Обновление индикаторов состояния мыши
- Отображение режима работы (абсолютный/относительный)
- Индикация захвата указателя

### Обработка событий мыши

#### `__streamButtonHandler(ev, state)`
- Обработка нажатий кнопок мыши на стриме
- Маппинг кнопок: 0=left, 1=middle, 2=right, 3=up, 4=down
- Автоматический захват указателя при клике в относительном режиме

#### `__streamMoveHandler(ev)`
- Обработка движения мыши
- В абсолютном режиме: вычисление позиции относительно стрима
- В относительном режиме: отправка дельты движения

#### `__streamScrollHandler(ev)`
- Обработка прокрутки колеса мыши
- Поддержка кумулятивной прокрутки
- Настройка направления и скорости

### Обработка сенсорных событий

#### `__streamTouchStartHandler(ev)`
- Обработка начала касания
- Одно касание: планирование движения или установка начальной позиции
- Два касания: подготовка к жесту прокрутки

#### `__streamTouchMoveHandler(ev)`
- Обработка движения касания
- Одно касание: отправка движения мыши
- Два касания: вычисление жеста прокрутки с порогом 15px

#### `__streamTouchEndHandler(ev)`
- Обработка окончания касания
- Отправка запланированных движений
- Сброс состояния жестов

#### `__getTouchPosition(ev, index)`
- Получение позиции касания относительно элемента
- Вычисление координат с учетом смещения элемента

### Отправка событий

#### `__sendPlannedMove()`
- Отправка запланированных движений мыши
- Абсолютный режим: маппинг координат в диапазон -32768..32767
- Относительный режим: отправка накопленных дельт

#### `__sendOrPlanRelativeMove(delta)`
- Отправка или планирование относительного движения
- Ограничение дельты в диапазоне -127..127
- Поддержка сжатия множественных движений

#### `__sendScroll(delta)`
- Отправка события прокрутки
- Применение настроек скорости и направления
- Поддержка обратной прокрутки

#### `__sendButton(button, state)`
- Отправка события кнопки мыши
- Поддержка всех типов кнопок
- Автоматическая отправка запланированных движений

#### `__sendEvent(ev_type, ev)`
- Универсальная функция отправки HID событий
- Отправка через WebSocket если соединение активно
- Запись событий для логирования

### Утилиты

#### `__isRelativeCaptured()`
- Проверка захвата относительной мыши
- Использование Pointer Lock API

#### `__relativeCapturedHandler()`
- Обработка событий захвата/освобождения указателя
- Обновление индикаторов состояния

## Текущие ограничения

1. Жесты ограничены - только базовые жесты прокрутки двумя пальцами
2. Нет поддержки масштабирования - отсутствует pinch-to-zoom
3. Ограниченная поддержка множественных касаний - только для прокрутки

## Возможности для расширения

### Новые жесты для добавления
1. Pinch-to-zoom - масштабирование изображения
2. Swipe gestures - жесты навигации (влево/вправо/вверх/вниз)
3. Long press - контекстное меню
4. Double tap - двойной клик
5. Three finger gestures - системные жесты
6. Edge swipes - жесты с края экрана

## Memo: Интеграция с React Native

### Совместимые части
- Логика обработки событий
- Алгоритмы вычисления позиций
- Система отправки HID событий
- Настройки и конфигурация

### Требующие адаптации
- DOM события → React Native Gesture Responder
- Pointer Lock API → альтернативные решения
- WebSocket → React Native WebSocket
- DOM элементы → React Native компоненты
